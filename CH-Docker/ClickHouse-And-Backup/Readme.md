# ClickHouse + ClickHouseBackup + SFTP

Запуск [ClickHouse Server](https://github.com/ClickHouse/ClickHouse) и [ClickHouse-Backup](https://github.com/Altinity/clickhouse-backup) для управления бэкапами, а также пример удаленного хранилище для бэкапов в виде SFTP-сервера на базе образа [atmoz/sftp](https://github.com/atmoz/sftp).

## Описание

Запуск сервера ClickHouse совместно с утилитой ClickHouse-Backup для формирования бэкапов + SFTP-сервера для удаленного хранилища бэкапов. Пример может быть использован в окружении разработки или тестирования. Для рабочего окружения необходимо дополнительные настройки в части безопасности, развертывания и так далее.

## Как запустить

При установленном Docker Engine и Docker Compose достаточно выполнить команду:

```bash
docker-compose up -d
```

Команду выполнять в каталоге с файлом **docker-compose.yml**. В результате будут созданы подкаталог **fs** с файлами конфигурации серверов ClickHouse, утилиты бэкапирования, каталогом данных сервера ClickHouse, а также сервером SFTP (добавлен для примера отправки бэкапов на удаленное хранилище).

## Как это работает

Для запуска окружения используются три составляющих:

* clickhouse-server - это сервис с сервером ClickHouse.
* clickhouse-backup - приложение для управления бэкапами ClickHouse.
* sftp-server - SFTP-сервер для удаленного хранения бэкапов ClickHouse.

### clickhouse-server

Для запуска используется образ [clickhouse/clickhouse-server](https://hub.docker.com/r/clickhouse/clickhouse-server) с параметрами:

* На основной хост пробрасываются порты сервера 8123 (HTTP) и 9000 (TCP)
* С основного хоста монтируются каталоги с файлами конфигурации сервера ClickHouse и файлами данных сервера ClickHouse:
    * **./fs/volumes/clickhouse/server/config.d** - каталог с файлом переопределения настроек сервера ClickHouse.
        * В примере разрешены подключения с любого хоста и используются стандартные порты.
    * **./fs/volumes/clickhouse/server/users.d** - каталог с файлом настроек пользователей сервера ClickHouse.
        * В примере для пользователя **default** убран пароль и дана возможность удаленного подключения.
    * **./fs/volumes/clickhouse/server/data** - каталог с данными сервера ClickHouse. По умолчанию может не создаваться и будет инициализирован сервисом при старте.
    * **./fs/volumes/clickhouse/server/docker-entrypoint-initdb.d** - можно настроить скрипты инициализации баз даннных при первом запуске.

**Итого: имеем запущенный сервис ClickHouse с возможностью доступа по стандартным портам под пользователем default без пароля.**

### clickhouse-backup

Для запуска используется образ [clickhouse-backup](https://hub.docker.com/r/altinity/clickhouse-backup) с параметрами:

* С основного хоста монтируются каталоги с файлами конфигурации утилиты clickhouse-backup и файлами данных сервера ClickHouse:
    * **./fs/volumes/clickhouse/server/data** - каталог с данными сервера ClickHouse. По умолчанию может не создаваться и будет инициализирован сервисом clickhouse-server при старте. Для утилиты бэкапирования нужно иметь прямой доступ к файлам данных ClickHouse для создания бэкапов с возможностью настройки жестких ссылок и др.
    * **./fs/volumes/clickhouse/backup-config** - каталог с файлами конфигурации утилиты clickhouse-backup. В файле по умолчанию настроены доступы к серверу ClickHouse и удаленое хранение бэкапов на SFTP-сервере.

**Итого: имеем настроенный запущенный сервис на базе clickhouse-backup для управления бэкапами и отправки их на SFTP-сервер.**
    
### sftp-server

Для запуска используется образ [atmoz/sftp](https://hub.docker.com/r/atmoz/sftp) с параметрами:

* SFTP-сервис использует 22 порт внутри сети контейнеров, и проброшен на порт 2222 на основной хост. Для простоты используется логин и пароль **sftp**.
* С основного хоста монтируются каталоги для хранения данных сервисом SFTP:
    * **./fs/volumes/sftp/upload** - каталог для хранения файлов SFTP-сервиса.

Итого: имеет поднятый SFTP-сервис для примера отправки бэкапов ClickHouse.